<!DOCTYPE html>
<!--
MatHud Mathematical Canvas Web Interface

Main HTML template for the interactive mathematical graphing calculator.
Provides AI-powered canvas for geometric shapes, calculations, and mathematical exploration.

Key Components:
    - MathJax: LaTeX mathematical notation rendering
    - Brython: Python-in-browser execution for canvas operations
    - SVG Canvas: Interactive mathematical visualization area
    - Chat Interface: AI communication with model selection and vision toggle
    - Responsive Layout: Dual-pane interface (canvas + chat)

Dependencies:
    - Google Fonts (Inter): Modern typography
    - MathJax 3: Mathematical equation rendering
    - Brython 3.12.5: Python runtime for browser-side logic
    - Flask templates: Dynamic asset URL generation
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>MatHud - Mathematical Canvas</title>
    
    <!-- Google Fonts for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax configuration for LaTeX mathematical notation rendering -->
    <script>
    window.MathJax = {
        tex: {
            inlineMath: [['\\(', '\\)']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Brython Python runtime and mathematical libraries from CDN (2025 latest versions) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.5.2/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Extra.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.12.5/brython.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.12.5/brython_stdlib.min.js"></script>
    
    <!-- Application styles -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">   
</head>
<body onload="initBrython()">
    <div class="container">
        <!-- Mathematical Canvas Area -->
        <div class="math-container" id="math-container">
            <!-- Logout button overlay -->
            <button id="logout-button-overlay" class="logout-overlay-button" style="display: none;" title="Logout">
                Ã—
            </button>
            <!-- SVG canvas for interactive mathematical visualizations -->
            <svg id="math-svg" style="width:100%; height:100%"></svg>
        </div>        
        
        <!-- AI Chat Interface -->
        <div class="chat-container">
            <!-- AI Model and Vision Configuration -->
            <div class="selection-container">
                <button id="new-conversation-button" title="Save workspace and start a new conversation">New Conversation</button>
                <div class="controls-group">
                    <div class="ai-model-selector">
                        <label for="ai-model-selector">Model:</label>
                        <select id="ai-model-selector">
                            <option value="gpt-4.1">GPT-4.1</option>
                            <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                            <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    <div class="vision-toggle">
                        <input type="checkbox" id="vision-toggle">
                        <label for="vision-toggle">Enable Vision</label>
                    </div>
                </div>
            </div>
            
            <!-- Chat History Display -->
            <div class="chat-history" id="chat-history"></div>
            
            <!-- User Input Area -->
            <div class="chat-input-container">
                <input class="chat-input" id="chat-input" type="text" placeholder="Type your message here...">
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Brython initialization and configuration -->
    <script>
    function initBrython() {
        // Configure Brython to use local paths for our modules
        brython({
            debug: 0,
            cache: 'browser',
            static_stdlib_import: true,
            async: true,
            pythonpath: ['{{ url_for("static", filename="python") }}']
        });
    }
    </script>
    
    <!-- Main Brython application entry point -->
    <script type="text/python" src="{{ url_for('static', filename='python/main.py') }}"></script>
    
    <!-- Vision toggle functionality based on AI model capabilities -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        var aiModelSelector = document.getElementById("ai-model-selector");
        var visionToggle = document.getElementById("vision-toggle");
        var visionLabel = document.querySelector("label[for='vision-toggle']");
        
        // Ensure vision is unchecked on page load
        visionToggle.checked = false;
        
        /**
         * Updates vision toggle availability based on selected AI model capabilities.
         * Vision features are only available for GPT-4 family models with vision support.
         */
        function updateVisionToggle() {
            if (aiModelSelector.value === "gpt-4.1" || 
                aiModelSelector.value === "gpt-4.1-mini" || 
                aiModelSelector.value === "gpt-4.1-nano" || 
                aiModelSelector.value === "gpt-4o" || 
                aiModelSelector.value === "gpt-4o-mini") {
                visionToggle.disabled = false;
                visionToggle.style.opacity = "1";
                visionLabel.style.color = "";
            } else {
                visionToggle.disabled = true;
                visionToggle.checked = false;
                visionToggle.style.opacity = "0.5";
                visionLabel.style.color = "gray";
            }
        }
        
        // Initialize vision toggle state on page load
        updateVisionToggle();

        // Update vision toggle when AI model selection changes
        aiModelSelector.addEventListener("change", updateVisionToggle);
        
        // ===== LOGOUT FUNCTIONALITY =====
        // Show logout button when authentication is enabled
        function checkAuthRequirement() {
            // Check if we need to show logout button by making a request to auth status endpoint
            fetch('/auth_status')
                .then(response => response.json())
                .then(data => {
                    console.log('Auth status response:', data); // Debug log
                    
                    // Check if authentication is required
                    const authRequired = data && data.data && data.data.auth_required;
                    
                    if (authRequired) {
                        console.log('Authentication required - showing logout button'); // Debug log
                        document.getElementById('logout-button-overlay').style.display = 'flex';
                    } else {
                        console.log('Authentication not required - hiding logout button'); // Debug log
                        document.getElementById('logout-button-overlay').style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.error('Error checking auth status:', error); // Debug log
                    // If there's an error, hide the logout button (safer default)
                    document.getElementById('logout-button-overlay').style.display = 'none';
                });
        }
        
        // Check auth requirement on page load
        checkAuthRequirement();
        
        // Handle logout button click
        document.getElementById('logout-button-overlay').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        });
        
        // ===== MOBILE KEYBOARD HANDLING =====
        // Detect virtual keyboard opening/closing and adjust UI
        var chatInputContainer = document.querySelector('.chat-input-container');
        var chatInput = document.getElementById('chat-input');
        var chatContainer = document.querySelector('.chat-container');
        var initialViewportHeight = window.innerHeight;
        var isKeyboardOpen = false;
        var originalScrollTop = 0;
        
        /**
         * Detects virtual keyboard state and adjusts UI accordingly
         */
        function handleViewportChange() {
            var currentViewportHeight = window.innerHeight;
            var heightDifference = initialViewportHeight - currentViewportHeight;
            
            // Threshold for detecting keyboard (150px+ indicates keyboard)
            var keyboardThreshold = 150;
            
            if (heightDifference > keyboardThreshold && !isKeyboardOpen) {
                // Keyboard opened
                isKeyboardOpen = true;
                originalScrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                
                chatInputContainer.classList.add('keyboard-open');
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                
                // Ensure input stays visible and centered
                setTimeout(function() {
                    chatInput.focus();
                    // Scroll to top to ensure input is visible
                    window.scrollTo(0, 0);
                }, 100);
                
            } else if (heightDifference <= keyboardThreshold && isKeyboardOpen) {
                // Keyboard closed - restore original state
                isKeyboardOpen = false;
                chatInputContainer.classList.remove('keyboard-open');
                document.body.style.overflow = ''; // Restore scrolling
                
                // Restore original scroll position
                setTimeout(function() {
                    window.scrollTo(0, originalScrollTop);
                }, 100);
            }
        }
        
        /**
         * Handle input focus - prepare for keyboard opening
         */
        function handleInputFocus() {
            // Store current scroll position
            originalScrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            
            // Small delay to detect if keyboard will open
            setTimeout(function() {
                var currentHeight = window.innerHeight;
                if (currentHeight < initialViewportHeight * 0.85) {
                    // Keyboard is opening, ensure input is visible
                    window.scrollTo(0, 0);
                }
            }, 300);
        }
        
        /**
         * Handle input blur - prepare for keyboard closing
         */
        function handleInputBlur() {
            // Small delay to allow keyboard to close
            setTimeout(function() {
                if (!isKeyboardOpen) {
                    // Keyboard has closed, restore state
                    document.body.style.overflow = '';
                    window.scrollTo(0, originalScrollTop);
                }
            }, 300);
        }
        
        // Listen for viewport changes (keyboard open/close)
        window.addEventListener('resize', handleViewportChange);
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                initialViewportHeight = window.innerHeight;
                handleViewportChange();
            }, 500);
        });
        
        // Listen for input focus and blur
        chatInput.addEventListener('focus', handleInputFocus);
        chatInput.addEventListener('blur', handleInputBlur);
        
        // Enhanced visual viewport API handling (newer browsers)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', function() {
                var keyboardHeight = window.innerHeight - window.visualViewport.height;
                
                if (keyboardHeight > 150 && !isKeyboardOpen) {
                    isKeyboardOpen = true;
                    originalScrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                    
                    chatInputContainer.classList.add('keyboard-open');
                    document.body.style.overflow = 'hidden';
                    window.scrollTo(0, 0);
                    
                } else if (keyboardHeight <= 150 && isKeyboardOpen) {
                    isKeyboardOpen = false;
                    chatInputContainer.classList.remove('keyboard-open');
                    document.body.style.overflow = '';
                    
                    // Restore scroll position
                    setTimeout(function() {
                        window.scrollTo(0, originalScrollTop);
                    }, 100);
                }
            });
        }
    });
    </script>
</body>
</html>