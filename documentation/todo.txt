# Delivery Plan (AI-First P0/P1/P2)

## Product Direction (Source of Truth)
- MatHud is an AI-augmented app: user intent is expressed in chat, AI executes tool workflows, HUD canvas visualizes results.
- Prioritize capabilities that improve AI intent interpretation, deterministic execution, and clear visual feedback in the HUD.
- UI gestures are secondary unless they directly support AI workflows (inspection, confirmation, lightweight overrides).

## P0 - Reliability (implement first)
- ~~refactor oversized classes/functions into smaller composable units while preserving 1:1 behavior (no logic changes); improve observability, readability, and structural clarity~~
- ~~make `search_tools` the default tool-discovery path to reduce initial context payload; deprecate legacy preloaded full-tool-list model prompting~~
- ~~audit canvas state structure end-to-end and redesign AI-facing state summaries for high-object-count scenes to improve readability and reasoning quality~~
- implement OpenAI OAuth for first-party subscription-token usage (third-party app flow) and make OAuth the default authentication path over raw API-key entry
- ~~perform a deep review of drawable dependency architecture and relationship rules; verify interaction coverage across drawable types and close logic gaps~~
- build a reproducible Android-target packaging/deployment pipeline for a mobile-runnable app variant
- defer full WebGL parity checks until WebGL reaches feature completeness (text/labels and full drawable coverage)
- ~~add deterministic tool-execution logs and replayability for AI action traces (inputs, resolved targets, resulting state deltas)~~

## P1 - Core User Value (implement after P0)
- constraint resolution and semantic snapping: resolve references like nearest endpoint/intersection/midpoint/on-curve target during tool execution
- coordinate readout and confirmations: return exact resolved coordinates/objects in responses and HUD overlays
- tabular workflow: create/query/update data tables from chat with HUD-linked previews
- CSV workflow: import/export datasets through chat commands with validation and schema feedback
- plotting suite: scatter/histogram/box plots, polar plots, implicit plots from natural language intents
- geometric construction toolkit: midpoint/perpendicular/parallel/bisectors/circle-through-3-points through declarative commands
- relation inspector: explain and verify geometric relations (parallel/perpendicular/collinear/concyclic/equal-length) on demand
- transform workflows: reflection/dilation/shear/rotation/translation using object references and constraint-aware execution
- interaction tools: tracing, root/extrema/intersection discovery, parameter sweeps, and dynamic slider orchestration from chat
- statistics workflows: summaries, additional distributions, and probability calculators with explanation-friendly output

## P2 - Advanced and Expansion
- construction history timeline with natural-language rewind/replay and branch exploration
- reusable macros: user-defined higher-level commands composed from existing tool primitives
- vector field and contour/heatmap generation with explainable parameterization
- graph-theory workflow: graph generation, editing, matrix views, and algorithm playback controlled through chat
- workspace orchestration: split-screen/tabbed/dual-view layouts selected and managed based on task context
- animation controls: timeline/loop/speed/locus generation via declarative commands
- session snapshots and diff/restore for reproducible exploratory workflows
- command palette and shortcut management (optional power-user overlay over core conversational UX)
- 3D roadmap: 3D graphing and shape workflows once 2D reliability/value goals are complete

## Milestones
- Milestone 1 (Stability): complete all P0 reliability and deterministic execution foundations
- Milestone 2 (AI Interaction Core): semantic snapping/constraint resolution, coordinate confirmations, table + CSV flows
- Milestone 3 (AI Plotting + Stats): plotting suite plus distribution/probability/stat-summary workflows
- Milestone 4 (AI Geometry): construction toolkit, relation inspector, and transform workflows
- Milestone 5 (AI Exploratory Workflow): tracing/sliders/interactive graph workflows and algorithm playback
- Milestone 6 (Advanced): remaining P2 capabilities (automation, visualization, productivity, 3D)

# Backlog

## Reliability and Execution Integrity
_Elaborates on P0 goals with ongoing design principles._
- strict validation and canonicalization of tool arguments before execution
- deterministic ordering for ambiguous target resolution (stable tie-break rules)
- WebGL parity and label support after WebGL matures

## Intent Resolution and Constraints
- semantic snapping modes: endpoint/intersection/midpoint/nearest-on-curve/grid quantization
- tolerance policy management for intent resolution (global defaults + per-command overrides)
- conflict handling when user intent is under-specified (ask-back strategy vs deterministic fallback)
- explainable resolution traces in AI responses (what was selected, why, and resulting coordinates)

## Data and Plot Workflows
- conversational table model for numeric/symbolic columns with formula support
- CSV import cleanup (typing, missing values, delimiter/header inference)
- plotting from natural language over table columns and computed expressions
- residual/regression diagnostics and model-comparison flows expressed conversationally
- reusable analysis templates callable as macros

## Geometry and Math Tooling
- declarative geometric constructions and relation proofs/checks
- linear algebra workflows (rref/eigen decomposition and related explainability output)
- ~~series partial-sum utilities~~
- ~~remaining: sequence/summation/product and numeric integration flows optimized for conversational use~~
- inequality/system region generation driven by intent + constraints
- conic and advanced curve workflows with parameter exploration

## Exploration, Collaboration, and Productivity
- session snapshots with semantic diffs suitable for AI summarization
- reproducible command/run logs that can be replayed in CI for regression detection
- "what changed" summaries after complex action batches
- optional command palette and keyboard editor for hybrid users without weakening AI-first design

## Future 3D and Extended Visualization
- staged 3D rendering architecture compatible with AI-driven command model
- 3D object/scene constraints and semantic target resolution
- 3D camera/navigation intent handling through conversational controls

## Parked (revisit when core AI workflows mature)
- differential equations solver and direction field visualization
- numerical ODE solvers
- truth tables and boolean algebra workflows
- financial mathematics (compound interest, annuities, amortization)
- hypothesis testing (z-test, t-test, chi-square, F-test), ANOVA, confidence intervals
- probability plots (Q-Q, P-P) and cumulative frequency tables

## Static Typing Rollout
- add type stubs or protocols for Brython `browser` module usage in client code

## Recent Completions
- 2026-02-14: added deterministic tool-execution logs and replayability for AI action traces. Per-call tracing in `ResultProcessor.get_results_traced()` records function name, sanitized arguments, result, error status, and wall-clock timing. `ActionTraceCollector` builds structured traces with canvas state deltas (added/removed/modified drawables), bounded FIFO storage (100 entries), compact server-side logging via `LogManager.log_action_trace()`, and trace replay through the public `ResultProcessor` API. Both streaming and legacy AIInterface paths instrumented. Browser JS APIs exposed: `window.getActionTraces()`, `getLastActionTrace()`, `clearActionTraces()`, `replayLastTrace()`. Validation: `pytest server_tests/` (873 passed, 22 skipped), `python -m cli.main test client --start-server` (2401 run, 0 failures, 0 errors). PR #38.
- 2026-02-11: completed canvas-state prompt summarization rollout baseline: server-side summarizer, hybrid/summarized prompt normalization with env controls, telemetry logging, small-scene hybrid fast path, filtered `get_current_canvas_state` retrieval, and developer comparison/reporting tooling. Validation included dedicated summarizer/openai_base/schema test suites plus prompt telemetry A/B measurements (small: 555->555 tokens, medium: 3782->2047, large: 14174->7444).
- 2026-02-10: completed conversational sequence/summation/product + numeric integration flow hardening by shipping strict-compatible `numeric_integrate` tool schema defaults (optional `method`/`steps`), restoring explicit `evaluate_expression` function-token discoverability while retaining series helpers, and adding function-call pipeline coverage for omitted optional integration args. Validation: `python run_server_tests.py` (847 passed, 24 skipped, 123 subtests) and `./venv/bin/python -m cli.main test client --start-server --timeout 240` (2372 run, 0 failures, 0 errors).
- 2026-02-10: added series partial-sum utilities (`static/client/utils/series.py`) with broad pure-Python and Brython-side coverage, plus registration into the client test runner. Follow-up hardening: bool inputs now rejected in numeric/int validators to avoid silent acceptance of `True`/`False` as numbers. Validation: `python -m pytest -q server_tests/test_series_pure.py` (69 passed, 6 subtests), `python -m cli.main test client --start-server --no-screenshot` (2367 run, 0 failures, 0 errors). Commit: `2c3efde`.
- 2026-02-08: dependency-architecture hardening phase completed for interactive drawables: normalized dependency cleanup in delete flows (point/circle/ellipse/graph/colored-area/function/parametric/piecewise/polygon/vector + direct triangle/rectangle removals), added dependency-graph invariant/lifecycle tests (delete/recreate), and codified/documented edge-neutral dependency contracts (Label, plot/bar families, parametric/piecewise). Added policy matrix docs in `documentation/development/dependency_policy_matrix.md`. Validation: `pytest -q server_tests` (771 passed, 22 skipped, 117 subtests), `python -m cli.main test client --start-server --port 5006 --timeout 240` (2351 run, 0 failures, 0 errors). Commits: `c601ec3`, `ee1202d`, `614edc4`.
- 2026-02-08: dependency-architecture hardening slice: guarded dependency registration against `None`/invalid drawable endpoints and added orphan-pruning on dependency unregister in `DrawableDependencyManager` (prevents polluted/stale dependency graph entries from malformed or removed relationships), with focused client dependency-manager tests. Validation: `pytest -q server_tests` (771 passed, 22 skipped, 117 subtests), `python -m cli.main test client --start-server --port 5000 --timeout 240` (2340 run, 0 failures, 0 errors).
- 2026-02-08: made `search_tools` the default tool-discovery path for app/provider initialization (search-first tool mode), with route/provider fallback handling for constructor compatibility. Validation: `pytest -q server_tests/test_routes.py` (30 passed), `pytest -q server_tests` (770 passed, 22 skipped, 117 subtests passed), `python -m cli.main test client --start-server --port 5000 --timeout 240` (2337 run, 0 failures, 0 errors). Commits: `47698ef` (feature), `86f6847` (ignore local runtime artifacts).
- 2026-02-08: expanded client unit-test coverage for PR #16 helper extractions (Canvas/WorkspaceManager pure helpers), integrated into the Brython client test suite, and verified via `venv\Scripts\python -m cli.main test client` (2313 tests, 0 failures).
- 2026-02-08: completed phased no-logic-change composable refactor stream (Phases 0-5), including manager/orchestrator/tool-pipeline decomposition, helper-level coverage expansion, and final hardening sign-off. Validation: full server regression (`769 passed, 22 skipped`) and full client regression (`2319 run, 0 failures`).
