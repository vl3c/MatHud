import unittest
from copy import deepcopy

from drawables.angle import Angle
from .simple_mock import SimpleMock

class TestAngle(unittest.TestCase):
    def setUp(self):
        # Setup for DrawableManager
        self.drawable_manager_segments = {}
        def get_segment_by_name_mock(name):
            return self.drawable_manager_segments.get(name)
        def add_segment_mock(segment):
            self.drawable_manager_segments[segment.name] = segment

        self.drawable_manager = SimpleMock(
            get_segment_by_name = get_segment_by_name_mock,
            add_segment = add_segment_mock
            # segments_by_name can be managed externally by add_segment_mock
        )

        # Setup for Canvas
        self.canvas = SimpleMock(
            drawable_manager=self.drawable_manager,
            # Add a no-op create_svg_element if any non-removed test path might call it.
            # Angle.draw() calls it. If all direct tests of draw() are removed,
            # only indirect calls (e.g. via get_state if it triggered drawing, or deepcopy) would matter.
            # For safety, include a minimal mock for it.
            create_svg_element = lambda tag_name, attributes, text_content=None: {"tag": tag_name, "attrs": attributes, "text": text_content}
        )
        
        # Points using SimpleMock with single letter names
        self.A = SimpleMock(name="A", x=0, y=0)
        self.B = SimpleMock(name="B", x=10, y=0)
        self.C = SimpleMock(name="C", x=0, y=10)
        self.D = SimpleMock(name="D", x=10, y=10)
        self.E = SimpleMock(name="E", x=-10, y=0)
        
        # Segments using SimpleMock with names derived from points
        self.s_AB = SimpleMock(name="AB", point1=self.A, point2=self.B, canvas=self.canvas)
        self.s_AC = SimpleMock(name="AC", point1=self.A, point2=self.C, canvas=self.canvas)
        self.s_AD = SimpleMock(name="AD", point1=self.A, point2=self.D, canvas=self.canvas)
        self.s_AE = SimpleMock(name="AE", point1=self.A, point2=self.E, canvas=self.canvas)
        self.s_BD = SimpleMock(name="BD", point1=self.B, point2=self.D, canvas=self.canvas) # Used for no common vertex test
        self.s_CD = SimpleMock(name="CD", point1=self.C, point2=self.D, canvas=self.canvas) # Used for no common vertex test

        # Add segments to the mock drawable_manager
        self.drawable_manager.add_segment(self.s_AB)
        self.drawable_manager.add_segment(self.s_AC)
        self.drawable_manager.add_segment(self.s_AD)
        self.drawable_manager.add_segment(self.s_AE)
        self.drawable_manager.add_segment(self.s_BD)
        self.drawable_manager.add_segment(self.s_CD)

    def test_initialization_valid_90_degrees(self):
        angle = Angle(self.s_AB, self.s_AC, self.canvas, label="Ninety")
        self.assertIsNotNone(angle)
        self.assertEqual(angle.label, "Ninety")
        # For SimpleMock, direct object comparison (is) should work for points if they are the same instances
        self.assertIs(angle.vertex_point, self.A)
        self.assertIs(angle.arm1_point, self.B)
        self.assertIs(angle.arm2_point, self.C)
        self.assertAlmostEqual(angle.angle_degrees, 90.0, places=5)
        # Points are A, B, C. Sorted names: A, B, C.
        self.assertEqual(angle.name, "angle_ABC")

    def test_initialization_valid_45_degrees(self):
        angle = Angle(self.s_AB, self.s_AD, self.canvas)
        self.assertIsNotNone(angle)
        self.assertIs(angle.vertex_point, self.A)
        self.assertIs(angle.arm1_point, self.B)
        self.assertIs(angle.arm2_point, self.D)
        self.assertAlmostEqual(angle.angle_degrees, 45.0, places=5)
        # Points are A, B, D. Sorted names: A, B, D.
        self.assertEqual(angle.name, "angle_ABD")

    def test_initialization_valid_180_degrees(self):
        angle = Angle(self.s_AB, self.s_AE, self.canvas)
        self.assertIsNotNone(angle)
        self.assertIs(angle.vertex_point, self.A)
        self.assertIs(angle.arm1_point, self.B)
        self.assertIs(angle.arm2_point, self.E)
        self.assertAlmostEqual(angle.angle_degrees, 180.0, places=5)
        # Points are A, B, E. Sorted names: A, B, E.
        self.assertEqual(angle.name, "angle_ABE")

    def test_initialization_invalid_no_common_vertex(self):
        # s_AB (A-B) and s_CD (C-D)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(self.s_AB, self.s_CD, self.canvas)

    def test_initialization_invalid_collinear_overlapping_same_segment(self):
        s_AB_copy = SimpleMock(name="AB_copy", point1=self.A, point2=self.B, canvas=self.canvas)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(self.s_AB, s_AB_copy, self.canvas)

    def test_initialization_invalid_one_segment_is_point_at_vertex(self):
        p_at_vertex = SimpleMock(name="A_vtx_copy", x=self.A.x, y=self.A.y) # Point identical to A
        s_degenerate = SimpleMock(name="S_Deg", point1=self.A, point2=p_at_vertex, canvas=self.canvas)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(self.s_AB, s_degenerate, self.canvas)

    def test_angle_calculation_270_degrees_or_minus_90(self):
        # Angle from s_AC (A-C) to s_AB (A-B)
        angle = Angle(self.s_AC, self.s_AB, self.canvas)
        self.assertAlmostEqual(angle.angle_degrees, 270.0, places=5)
        # Points are A, C, B. Sorted names: A, B, C.
        self.assertEqual(angle.name, "angle_ABC")

    def test_angle_calculation_zero_length_arm(self):
        A_copy = SimpleMock(name="A_copy", x=self.A.x, y=self.A.y)
        s_zero_arm = SimpleMock(name="S_Zero", point1=self.A, point2=A_copy, canvas=self.canvas)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
             Angle(s_zero_arm, self.s_AC, self.canvas)

    def test_initialization_with_none_segment(self):
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(None, self.s_AC, self.canvas)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(self.s_AB, None, self.canvas)
        with self.assertRaisesRegex(ValueError, "segments do not form a valid angle"):
            Angle(None, None, self.canvas)

    def test_get_class_name(self):
        angle = Angle(self.s_AB, self.s_AC, self.canvas)
        self.assertEqual(angle.get_class_name(), 'Angle')

    def test_canvas_property(self):
        angle = Angle(self.s_AB, self.s_AC, self.canvas)
        self.assertIs(angle.canvas, self.canvas)
        self.assertIs(angle.segment1.canvas, self.canvas)
        self.assertIs(angle.segment2.canvas, self.canvas)

        new_canvas_mock = SimpleMock(name="NewCanvas")
        angle.canvas = new_canvas_mock
        self.assertIs(angle.canvas, new_canvas_mock)
        # Check if segments' canvas reference was updated
        self.assertIs(angle.segment1.canvas, new_canvas_mock)
        self.assertIs(angle.segment2.canvas, new_canvas_mock)

    def test_get_state_and_from_state(self):
        # Angle from s_AB, s_AD. Points A, B, D. Sorted: A,B,D. Name: angle_ABD
        angle1 = Angle(self.s_AB, self.s_AD, self.canvas, label="TestAngle") 
        self.assertEqual(angle1.name, "angle_ABD")
        state = angle1.get_state()

        expected_state = {
            "name": "angle_ABD",
            "type": "angle",
            "args": {
                "segment1_name": "AB",
                "segment2_name": "AD",
                "label": "TestAngle",
                "color": "black"
            }
        }
        self.assertEqual(state, expected_state)

        self.drawable_manager.add_segment(self.s_AB)
        self.drawable_manager.add_segment(self.s_AD)

        angle2 = Angle.from_state(state, self.canvas)
        self.assertIsNotNone(angle2)
        self.assertEqual(angle2.name, "angle_ABD")
        self.assertEqual(angle2.label, "TestAngle")
        self.assertEqual(angle2.color, "black")
        self.assertEqual(angle2.segment1.name, "AB")
        self.assertEqual(angle2.segment2.name, "AD")
        self.assertAlmostEqual(angle2.angle_degrees, 45.0, places=5)

    def test_from_state_segment_not_found(self):
        state = {
            "name": "ghost_angle", # This name won't match regenerated if segments were found
            "type": "angle",
            "args": {"segment1_name": "NonExistentS1", "segment2_name": "AD", "label": "Ghost"}
        }
        self.drawable_manager.add_segment(self.s_AD)
        
        angle = Angle.from_state(state, self.canvas)
        self.assertIsNone(angle)

    def test_update_points_based_on_segments(self):
        # Angle from s_AB, s_AC. Points A,B,C. Expected angle 90.
        angle = Angle(self.s_AB, self.s_AC, self.canvas)
        self.assertAlmostEqual(angle.angle_degrees, 90.0)

        original_C_y = self.C.y
        original_C_x = self.C.x
        self.C.x = 10 # C was (0,10), now (10,0) which is B's location
        self.C.y = 0 
        
        if hasattr(angle, 'update_points_based_on_segments'):
            result = angle.update_points_based_on_segments()
            self.assertTrue(result) 
            self.assertAlmostEqual(angle.angle_degrees, 0.0, places=5)
        else:
            angle._initialize()
            self.assertAlmostEqual(angle.angle_degrees, 0.0, places=5)

        self.C.x = original_C_x
        self.C.y = original_C_y

    def test_update_makes_angle_invalid(self):
        angle = Angle(self.s_AB, self.s_AC, self.canvas)
        
        original_B_x = self.B.x
        original_B_y = self.B.y
        self.B.x = self.A.x # Move B to A's location
        self.B.y = self.A.y

        if hasattr(angle, 'update_points_based_on_segments'):
            result = angle.update_points_based_on_segments()
            self.assertFalse(result) 
            self.assertIsNone(angle.angle_degrees)
        else:
            angle._initialize()
            self.assertIsNone(angle.angle_degrees)

        self.B.x = original_B_x
        self.B.y = original_B_y

    def test_deepcopy_basic(self):
        # Angle from s_AB, s_AD. Points A,B,D. Name: angle_ABD
        original_angle = Angle(self.s_AB, self.s_AD, self.canvas, label="Original")
        self.assertEqual(original_angle.name, "angle_ABD")

        memo = {}
        memo[id(self.canvas)] = self.canvas

        copied_angle = deepcopy(original_angle, memo)

        self.assertNotEqual(id(original_angle), id(copied_angle))
        self.assertEqual(copied_angle.name, "angle_ABD")
        self.assertEqual(copied_angle.label, "Original")
        self.assertEqual(copied_angle.color, "black")
        self.assertEqual(copied_angle.segment1.name, "AB") 
        self.assertEqual(copied_angle.segment2.name, "AD") 
        
        # Check if segments are new instances. Default deepcopy of SimpleMock should create new instances.
        self.assertIsNot(copied_angle.segment1, original_angle.segment1)
        self.assertIsNot(copied_angle.segment2, original_angle.segment2)
        
        # Check if points within segments are new instances (if segments were truly deepcopied with their points)
        self.assertIsNot(copied_angle.segment1.point1, original_angle.segment1.point1)
        self.assertIsNot(copied_angle.segment1.point2, original_angle.segment1.point2)