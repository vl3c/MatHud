from browser import document
from point import Position, Point
from math_geometry import Segment, Vector, Triangle
from cartesian_system_2axis import Cartesian2Axis

class Canvas:
    def __init__(self):
        self.drawables = []
        math_viewport = document['math-svg'].getBoundingClientRect()
        self.width = math_viewport.width
        self.height = math_viewport.height
        self.center = Position(self.width / 2, self.height / 2)
        self.scale_factor = 1  # Default scale factor is 1 (no scaling)
        self.zoom_point = Position(0, 0)  # Default zoom point is at origin
        self.zoom_direction = 0  # Default zoom direction is 0 (no zoom)
        self.zoom_step = 0.1  # Default zoom step is 0.1 (10%)
        self.dragging = False
        self.offset = Position(0, 0)  # Default offset is 0
        self.cartesian2axis = Cartesian2Axis(self)
        self.cartesian2axis.origin = Point(x=0, y=0, canvas=self, name="cartesian-origin")
        self.cartesian2axis.draw()

    def add_drawable(self, drawable):
        drawable.canvas = self  # Set the drawable's canvas reference
        self.drawables.append(drawable)

    def draw(self, apply_zoom=False):
        svg_container = document["math-svg"]
        svg_container.clear()
        self._draw_cartesian(apply_zoom)
        for drawable in self.drawables:
            drawable.pan()
            if apply_zoom:
                drawable.zoom()
            drawable.draw()  # Draw each drawable
        self.offset = Position(0, 0)  # Reset the offset

    def _draw_cartesian(self, apply_zoom=False):
        self.cartesian2axis.pan()
        if apply_zoom:
            self.cartesian2axis.zoom()
        self.cartesian2axis.draw()

    def clear(self):
        for drawable in self.drawables:
            drawable.canvas = None  # Clear the drawable's canvas reference
        self.drawables = []  # Clear the list of drawables

    def reset(self):
        self.scale_factor = 1
        self.offset = Position(0, 0)
        self.zoom_direction = 0
        for drawable in self.drawables:
            drawable.reset()
    
    def get_drawables_state(self):
        state = []
        for drawable in self.drawables:
            state.append(drawable.get_state())
        return state
    
    def _delete_dependencies(self, x, y):
        for drawable in self.drawables:
            if drawable.get_class_name() == 'Segment' and \
                (drawable.point1.original_position.x == x and drawable.point1.original_position.y == y or \
                    drawable.point2.original_position.x == x and drawable.point2.original_position.y == y):
                self.drawables.remove(drawable)
            if drawable.get_class_name() == 'Vector' and \
                (drawable.segment.point1.original_position.x == x and drawable.segment.point1.original_position.y == y or \
                    drawable.segment.point2.original_position.x == x and drawable.segment.point2.original_position.y == y):
                self.drawables.remove(drawable)
            if drawable.get_class_name() == 'Triangle' and \
                (drawable.segment1.point1.original_position.x == x and drawable.segment1.point1.original_position.y == y or \
                    drawable.segment2.point1.original_position.x == x and drawable.segment2.point1.original_position.y == y or \
                        drawable.segment3.point1.original_position.x == x and drawable.segment3.point1.original_position.y == y):
                self.drawables.remove(drawable)

    def get_point(self, x, y):
        for drawable in self.drawables:
            if drawable.get_class_name() == 'Point' and drawable.original_position.x == x and drawable.original_position.y == y:
                return drawable
        return None

    def create_point(self, x, y, name=""):
        p = self.get_point(x, y)
        if p:
            if name != "":
                p.name = name
                self.draw()
            return
        point = Point(x, y, canvas=self, name=name)
        self.add_drawable(point)
        self.draw()

    def delete_point(self, x, y):
        self._delete_dependencies(x, y)
        for drawable in self.drawables:
            if drawable.get_class_name() == 'Point' and drawable.original_position.x == x and drawable.original_position.y == y:
                self.drawables.remove(drawable)
                self.draw()
                break
    
    def get_segment(self, x1, y1, x2, y2):
        for drawable in self.drawables:
            if (drawable.get_class_name() == 'Segment') and \
                ((drawable.point1.original_position.x == x1 and drawable.point1.original_position.y == y1 and \
                    drawable.point2.original_position.x == x2 and drawable.point2.original_position.y == y2) or \
                        (drawable.point1.original_position.x == x2 and drawable.point1.original_position.y == y2 and \
                            drawable.point2.original_position.x == x1 and drawable.point2.original_position.y == y1)):
                return drawable
        return None

    def create_segment(self, x1, y1, x2, y2, name=""):
        segment = Segment(x1, y1, x2, y2, canvas=self, name=name)
        self.add_drawable(segment)
        self.draw()

    def delete_segment(self, x1, y1, x2, y2):
        for drawable in self.drawables:
            if drawable.get_class_name() == 'Segment' and \
                drawable.point1.original_position.x == x1 and drawable.point1.original_position.y == y1 and \
                    drawable.point2.original_position.x == x2 and drawable.point2.original_position.y == y2:
                self.drawables.remove(drawable)
                self.draw()
                break
                
    def create_vector(self, origin_x, origin_y, tip_x, tip_y, name=""):
        vector = Vector(origin_x, origin_y, tip_x, tip_y, canvas=self, name=name)
        self.add_drawable(vector)
        self.draw()

    def delete_vector(self, origin_x, origin_y, tip_x, tip_y):
        for drawable in self.drawables:
            if drawable.get_class_name() == 'Vector' and \
                drawable.segment.point1.original_position.x == origin_x and drawable.segment.point1.original_position.y == origin_y and \
                    drawable.segment.point2.original_position.x == tip_x and drawable.segment.point2.original_position.y == tip_y:
                self.drawables.remove(drawable)
                self.draw()
                break

    def create_triangle(self, x1, y1, x2, y2, x3, y3, name=""):
        triangle = Triangle(x1, y1, x2, y2, x3, y3, canvas=self, name=name)
        self.add_drawable(triangle)
        self.draw()

    def delete_triangle(self, x1, y1, x2, y2, x3, y3):
        self.delete_point(x1, y1)
        self.delete_point(x2, y2)
        self.delete_point(x3, y3)